<% if (locals.stage) { %>
  <section class="card">
    <h2><%= stage.WikiCombinedTitle %></h2>
    <div class="tab-list" role="tablist">
      <button role="tab" id="tab-display" class="tab <%= tab === 'display' ? 'active' : '' %>"
              ui-action="tab: #tabpanel-display, storyTabs; set-query-param: tab=display">Display</button>

      <button role="tab" id="tab-wikitext" class="tab <%= tab === 'wikitext' ? 'active' : '' %>"
              ui-action="tab: #tabpanel-wikitext, storyTabs; set-query-param: tab=wikitext">Wikitext</button>
    </div>
    <div role="tabpanel" aria-labelledby="tab-display" class="tabpanel <%= tab === 'display' ? 'active' : 'hide' %> content" id="tabpanel-display">
      <table class="article-table">
        <thead>
        <tr>
          <th colspan="3">Stage Properties</th>
        </tr>
        </thead>
        <tr>
          <td class="bold" colspan="2">Stage ID</td>
          <td class="w70p"><%= stage.Id %></td>
        </tr>
        <tr>
        <tr>
          <td class="no-border">&nbsp;</td>
          <td class="bold">Enemy Name</td>
          <td class="w70p"><%= stage.EnemyNameText || 'n/a' %></td>
        </tr>
        <tr>
          <td class="no-border">&nbsp;</td>
          <td class="bold">Level Name</td>
          <td class="w70p"><%= stage?.Reward?.LevelNameText || 'n/a' %></td>
        </tr>
        <tr>
          <td class="no-border">&nbsp;</td>
          <td class="bold">Level Type</td>
          <td class="w70p"><code><%= stage.LevelType || 'n/a' %></code></td>
        </tr>
        <tr>
          <td class="no-border">&nbsp;</td>
          <td class="bold" style="padding-left:20px">Wiki Group</td>
          <td class="w70p"><%= stage.WikiGroup %></td>
        </tr>
        <tr>
          <td class="no-border">&nbsp;</td>
          <td class="bold" style="padding-left:20px">Wiki Type</td>
          <td class="w70p"><%= stage.WikiType %></td>
        </tr>
        <% if (stage.LevelDifficulty) { %>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold" style="padding-left:20px">Level Difficulty</td>
            <td class="w70p"><%= stage.LevelDifficulty === 'NORMAL' ? 'Friendly Fracas' : 'Serious Showdown' %></td>
          </tr>
        <% } %>
        <tr>
          <td class="no-border">&nbsp;</td>
          <td class="bold">Min. Player Level</td>
          <td class="w70p"><%= stage.MinPlayerLevel || 'n/a' %></td>
        </tr>
        <% if (stage.Reward) { %>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Intro Text</td>
            <td class="w70p"><%- include('partials/util/wikitext', { content: normText(stage.Reward.IntroText), seamless: true }) %></td>
          </tr>
        <% } %>
        <% if (stage?.WorldLevel?.MapDescText) { %>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Map Description</td>
            <td class="w70p"><%- include('partials/util/wikitext', { content: normText(stage.WorldLevel.MapDescText), seamless: true }) %></td>
          </tr>
        <% } %>
      </table>
      <% if (stage.LevelLock) { %>
        <table class="article-table">
          <tr>
            <th colspan="3">Ascension Challenge</th>
          </tr>
          <% if (stage.LevelLock.UnlockLevel) { %>
            <tr>
              <td class="no-border">&nbsp;</td>
              <td class="bold">Player Level</td>
              <td class="w70p"><%= stage.LevelLock.UnlockLevel %></td>
            </tr>
          <% } %>
          <% if (stage.LevelLock.UnlockDescText) { %>
            <tr>
              <td class="no-border">&nbsp;</td>
              <td class="bold">Description</td>
              <td class="w70p"><%= normText(stage.LevelLock.UnlockDescText) %></td>
            </tr>
          <% } %>
          <% if (stage.LevelLock.UnlockMainQuestId) { %>
            <tr>
              <td class="no-border">&nbsp;</td>
              <td class="bold">Quest</td>
              <td class="w70p"><a href="/quests/<%= stage.LevelLock.UnlockMainQuestId %>"><%= stage.LevelLock.QuestTitleText %></a></td>
            </tr>
          <% } %>
        </table>
      <% } %>
      <% if (stage.Reward) { %>
        <% if (stage.Reward.ObjectiveTextList && stage.Reward.ObjectiveTextList.length) { %>
          <table class="article-table">
            <tr>
              <th colspan="3">Objectives</th>
            </tr>
            <% for (let [index, objectiveText] of Object.entries(stage.Reward.ObjectiveTextList)) { %>
              <tr>
                <td class="no-border">&nbsp;</td>
                <td class="bold"><%= objectiveText %></td>
                <td class="w70p">
                  <div class="spacer10-all">
                    <% for (let reward of stage.Reward.ChallengeRewardList[index].Reward.RewardItemList) { %>
                      <%- include('partials/archive/item', { material: reward.Material, itemCount: reward.ItemCount }) %>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% } %>
          </table>
        <% } %>
        <% if (stage.Reward.MappedFailTips && stage.Reward.MappedFailTips.length) { %>
          <table class="article-table">
            <tr>
              <th colspan="3">Fail Tips</th>
            </tr>
            <% for (let [index, failTipText] of Object.entries(stage.Reward.MappedFailTips)) { %>
              <tr>
                <td class="no-border">&nbsp;</td>
                <td class="bold">Fail Tip <%= (toInt(index) + 1) %></td>
                <td class="w70p"><%= failTipText %></td>
              </tr>
            <% } %>
          </table>
        <% } %>
      <% } %>
      <% if (stage.Rule && false) { %>
        <table class="article-table">
          <tr>
            <th colspan="3">Rule</th>
          </tr>
            <tr>
              <td class="no-border">&nbsp;</td>
              <td class="bold">Rule ID</td>
              <td class="w70p"><%= stage.RuleId %></td>
            </tr>
            <tr>
              <td class="no-border">&nbsp;</td>
              <td class="bold">FirstDrawNum</td>
              <td class="w70p"><%= stage.Rule.FirstDrawNum %></td>
            </tr>
            <tr>
              <td class="no-border">&nbsp;</td>
              <td class="bold">SecondDrawNum</td>
              <td class="w70p"><%= stage.Rule.SecondDrawNum %></td>
            </tr>
            <tr>
              <td class="no-border">&nbsp;</td>
              <td class="bold">DrawCardNum</td>
              <td class="w70p"><%= stage.Rule.DrawCardNum %></td>
            </tr>
            <tr>
              <td class="no-border">&nbsp;</td>
              <td class="bold">HandCardLimit</td>
              <td class="w70p"><%= stage.Rule.HandCardLimit %></td>
            </tr>
        </table>
      <% } %>
      <% if (stage.CardGroup) { %>
        <table class="article-table">
          <tr>
            <th colspan="3">Player Deck</th>
          </tr>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Player Card Group ID</td>
            <td class="w70p"><%= stage.CardGroupId %></td>
          </tr>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Active</td>
            <td class="w70p">
              <% for (let characterCard of stage.CardGroup.MappedCharacterList) { %>
                <%- include('partials/gcg/card', { card: characterCard }) %>
              <% } %>
            </td>
          </tr>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Action</td>
            <td class="w70p">
              <% for (let actionCard of stage.CardGroup.MappedCardList) { %>
                <%- include('partials/gcg/card', { card: actionCard }) %>
              <% } %>
            </td>
          </tr>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Reserve</td>
            <td class="w70p">
              <% for (let characterCard of stage.CardGroup.MappedWaitingCharacterList) { %>
                <%- include('partials/gcg/card', { card: characterCard }) %>
              <% } %>
            </td>
          </tr>
        </table>
      <% } %>
      <% if (stage.EnemyCardGroup) { %>
        <table class="article-table">
          <tr>
            <th colspan="3">Enemy Deck</th>
          </tr>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Enemy Card Group ID</td>
            <td class="w70p"><%= stage.EnemyCardGroupId %></td>
          </tr>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Active</td>
            <td class="w70p">
              <% for (let characterCard of stage.EnemyCardGroup.MappedCharacterList) { %>
                <%- include('partials/gcg/card', { card: characterCard }) %>
              <% } %>
            </td>
          </tr>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Action</td>
            <td class="w70p">
              <% for (let actionCard of stage.EnemyCardGroup.MappedCardList) { %>
                <%- include('partials/gcg/card', { card: actionCard }) %>
              <% } %>
            </td>
          </tr>
          <tr>
            <td class="no-border">&nbsp;</td>
            <td class="bold">Reserve</td>
            <td class="w70p">
              <% for (let characterCard of stage.EnemyCardGroup.MappedWaitingCharacterList) { %>
                <%- include('partials/gcg/card', { card: characterCard }) %>
              <% } %>
            </td>
          </tr>
        </table>
      <% } %>
    </div>
    <div role="tabpanel" aria-labelledby="tab-wikitext" class="tabpanel <%= tab === 'wikitext' ? 'active' : 'hide' %>" id="tabpanel-wikitext">
      Not implemented yet.
    </div>
  </section>
<% } else { %>
  <section class="card">
    <h2>TCG Stage not found</h2>
  </section>
<% } %>
<style>
td:first-of-type.no-border {
  width: 20px;
}
</style>