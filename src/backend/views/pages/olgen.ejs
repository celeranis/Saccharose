<section class="card">
  <h2>OL Generate</h2>
  <div class="content">
    <p class="spacer5-bottom">Generate <%- Tl('Other Languages') %> template with official names filled out.</p>
    <div class="field valign">
      <div class="valign grow" style="max-width:500px">
        <input class="ol-input grow" type="text" placeholder="Enter a name (case insensitive)" />
        <button class="ol-submit primary primary--2 spacer5-left">Generate</button>
      </div>
      <div class="ol-submit-pending hide loading small spacer5-left"></div>
    </div>
    <div class="talign spacer15-top spacer10-bottom flexWrap">
      <fieldset>
        <legend><code>_tl</code> options</legend>
        <div class="field spacer5-horiz" style="padding-right:30px">
          <label class="ui-radio dispBlock" style="padding-left:5px;font-size:13px;">
            <input type="radio" name="tl_options" value="none" <%= cookieTernary('OL.tl_options', {equalsOrEmpty: 'none', then: 'checked'}) %> />
            <span>Include <code>[lang]_tl</code> params*</span>
          </label>
          <label class="ui-radio dispBlock" style="padding-left:5px;font-size:13px;">
            <input type="radio" name="tl_options" value="exclude_tl" <%= cookieTernary('OL.tl_options', {equals: 'exclude_tl', then: 'checked'}) %> />
            <span>Exclude <code>[lang]_tl</code> params</span>
          </label>
        </div>
      </fieldset>
      <fieldset class="spacer5-left">
        <legend><code>_rm</code> options</legend>
        <div class="field spacer5-horiz" style="padding-right:30px">
          <label class="ui-radio dispBlock" style="padding-left:5px;font-size:13px;">
            <input type="radio" name="rm_options" value="none" <%= cookieTernary('OL.rm_options', {equalsOrEmpty: 'none', then: 'checked'}) %> />
            <span>Include <code>[lang]_rm</code> params</span>
          </label>
          <label class="ui-radio dispBlock" style="padding-left:5px;font-size:13px;">
            <input type="radio" name="rm_options" value="exclude_rm" <%= cookieTernary('OL.rm_options', {equals: 'exclude_rm', then: 'checked'}) %> />
            <span>Exclude <code>[lang]_rm</code> params</span>
          </label>
        </div>
      </fieldset>
    </div>
    <hr class="spacer5">
    <p style="padding:5px;font-size:0.85em">This utility will only work if there is an exact entire-value match for the name you're looking for in the TextMap. If the only reference to the name you're looking for is in a larger line of text, then it won't be found.</p>
    <p style="padding:0 5px 5px;margin:0;font-size:0.85em">e.g. it'd only match against <code style="font-size:0.85em">"Iris"</code> and not <code style="font-size:0.85em">"Cyrus' Letter to Iris"</code> if searching for <code>Iris</code></p>
    <p style="padding:0 5px;margin:0;font-size:0.85em">* <code style="font-size:0.8em">[lang]_tl</code> params are automatically excluded if the language text is the same as EN text.</p>
  </div>
</section>
<div id="ol-results-list"></div>
<script nonce="<%= req.context.nonce %>">
waitForConstant('app', app => {
  const listeners = [
    {
      el: '.ol-input',
      ev: 'enter',
      fn: function(event, target) {
        document.querySelector('.ol-submit').click();
      }
    },
    {
      el: 'input[type="radio"][name="tl_options"],input[type="radio"][name="rm_options"]',
      ev: 'input',
      multiple: true,
      fn: function(event, target) {
        let name = target.name;
        let value = target.value;
        Cookies.set('OL.'+name, value, { expires: 365 });
      }
    },
    {
      el: '.ol-submit',
      ev: 'click',
      fn: function(event, target) {
        let inputEl = document.querySelector('.ol-input');
        let loadingEl = document.querySelector('.ol-submit-pending');
        let tlOptionValue = document.querySelector('input[type="radio"][name="tl_options"]:checked').value;
        let rmOptionValue = document.querySelector('input[type="radio"][name="rm_options"]:checked').value;
        let text = inputEl.value.trim();

        if (!text) {
          app.flashTippy(inputEl, {content: 'Enter a name first!', delay:[0,2000]});
          return;
        }

        loadingEl.classList.remove('hide');
        inputEl.disabled = true;
        target.disabled = true;

        app.endpoints.generateOL(text, tlOptionValue === 'exclude_tl', tlOptionValue === 'exclude_tl', rmOptionValue === 'exclude_rm', true).then(result => {
          if (typeof result === 'string') {
            document.querySelector('#ol-results-list').innerHTML = result;
            if (!result.includes('no-results-found')) {
              inputEl.value = '';
            }
            app.startListeners([
              {
                el: '.ol-result-copy',
                ev: 'click',
                multiple: true,
                fn: function(event, target) {
                  copyToClipboard(target.closest('.ol-result').querySelector('.ol-result-textarea').value);
                }
              }
            ], document.querySelector('#ol-results-list'));
          } else if (typeof result === 'object' && result.error_description) {
            if (result.error_code === 'NOT_FOUND') {
              document.querySelector('#ol-results-list').innerHTML = 'Not Found: ' + result.error_description;
            } else {
              document.querySelector('#ol-results-list').innerHTML = result.error_code + ': ' + result.error_description;
            }
          }
        }).finally(() => {
          loadingEl.classList.add('hide');
          inputEl.disabled = false;
          target.disabled = false;
        });
      }
    },
  ];

  app.startListeners(listeners);
});
</script>